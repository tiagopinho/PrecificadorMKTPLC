<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Precificador Markup</title>
  <style>
    :root{
      color-scheme: dark;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --label-size: 15px;
      --input-size: 16px;
      --input-pad: 10px;
      --input-width: 100%;
      
      /* Tema escuro */
      --bg-body: #000000;
      --bg-card: #1a1a1a;
      --border-color: #333333;
      --text-color: #ffffff;
      --text-muted: #888888;
      --input-bg: #2a2a2a;
      --input-border: #404040;
      --accent-green: #00ff88;
    }
    
    html, body{ 
      margin:0; padding:0; 
      background-color: var(--bg-body);
      color: var(--text-color);
    }
    body{ padding:12px; -webkit-text-size-adjust:100%; }
    h1{ margin:0 0 16px 0; font-size:1.4rem; color: var(--text-color); }
    
    .card{
      background-color: var(--bg-card);
      border:1px solid var(--border-color);
      border-radius:12px; 
      padding:14px; 
      margin-bottom:12px;
    }

    /* linhas padrão (2 colunas): label | input */
    .row{
      display:grid; grid-template-columns: 1fr 90px;
      gap:10px; align-items:center; margin:8px 0;
    }

    /* linhas de porcentagem (3 colunas): label | input | valor em R$ */
    .rowpct{
      display:grid; grid-template-columns: 1fr 70px 90px;
      gap:10px; align-items:center; margin:8px 0;
    }
    .result-right{ 
      text-align:right; 
      font-weight:600; 
      color: var(--text-color);
      font-size: 14px;
    }

    /* linha do produto */
    .row4{
      display:grid;
      grid-template-columns:
        minmax(120px, 1fr)
        10px
        80px
        10px
        32px
        10px
        60px;
      align-items:center;
      margin:8px 0;
    }

    .row4 > label{
      font-weight:600; 
      font-size:var(--label-size);
      white-space:nowrap; 
      overflow:hidden; 
      text-overflow:ellipsis;
      color: var(--text-color);
    }
    .qtd-label{ 
      white-space:nowrap; 
      text-align:center; 
      font-weight:600; 
      color: var(--text-color);
      font-size: 14px;
      min-width: 32px;
    }

    input[type="number"], input[type="text"]{
      padding:var(--input-pad);
      border-radius:8px;
      border:1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text-color);
      font-size:var(--input-size);
      -webkit-appearance:none; 
      appearance:none;
      width:var(--input-width);
      box-sizing:border-box;
    }
    
    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #666;
    }
    
    input::placeholder {
      color: var(--text-muted);
    }
    
    /* garantem as larguras definidas na grid */
    .row4 input.money{ width:80px; }
    .row4 input.qty  { width:60px; }

    .muted{ color: var(--text-muted); font-size:.9rem; }
    .result{ 
      font-weight:700; 
      font-size:1.15rem; 
      color: var(--text-color);
    }
    .result-big{
      font-weight:700; 
      font-size:1.8rem; 
      color: var(--accent-green);
    }
    .warn{ color:#ff6b35; }
    .toggle{ 
      display:flex; 
      align-items:center; 
      gap:8px; 
      margin-bottom: 12px;
    }
    
    .toggle label {
      color: var(--text-color);
      font-size: 15px;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-green);
    }

    /* Labels mais compactos */
    .compact-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
    }

    @media (max-width:360px){
      .row4{
        grid-template-columns:
          minmax(110px,1fr) 6px 70px 6px max-content 6px 55px;
      }
      .row4 input.money{ width:70px; }
      .row4 input.qty  { width:55px; }

      .rowpct{ grid-template-columns: 1fr 66px 85px; }
    }
  </style>
</head>
<body>
  <h1>Precificador Markup</h1>

  <div class="card">
    <div class="toggle">
      <input type="checkbox" id="divide2" checked aria-label="Dividir total por 2">
      <label for="divide2">Dividir TOTAL DE CUSTO por 2</label>
    </div>

    <div id="items"></div>

    <div class="row">
      <label>TOTAL DE CUSTO</label>
      <div id="b7" class="result">R$ 0,00</div>
    </div>
  </div>

  <div class="card">
    <div class="rowpct">
      <label class="compact-label">MARGEM LUCRO</label>
      <input type="number" inputmode="decimal" step="0.01" id="b8" placeholder="%">
      <div id="r_b8" class="result-right">R$ 0,00</div>
    </div>
    <div class="rowpct">
      <label class="compact-label">CUSTO FIXO / FRETE</label>
      <input type="number" inputmode="decimal" step="0.01" id="b9" placeholder="R$">
      <div></div>
    </div>
    <div class="rowpct">
      <label class="compact-label">IMPOSTO</label>
      <input type="number" inputmode="decimal" step="0.01" id="b10" placeholder="%">
      <div id="r_b10" class="result-right">R$ 0,00</div>
    </div>
    <div class="rowpct">
      <label class="compact-label">FIXO</label>
      <input type="number" inputmode="decimal" step="0.01" id="b11" placeholder="%">
      <div id="r_b11" class="result-right">R$ 0,00</div>
    </div>
    <div class="rowpct">
      <label class="compact-label">COMISSÃO</label>
      <input type="number" inputmode="decimal" step="0.01" id="b12" placeholder="%">
      <div id="r_b12" class="result-right">R$ 0,00</div>
    </div>
  </div>

  <div class="card">
    <div id="warn" class="warn muted" style="display:none;">⚠️ A soma dos percentuais (lucro + impostos + fixo + comissão) precisa ser menor que 100%.</div>
    <div class="row">
      <label>VALOR ANÚNCIO</label>
      <div id="b13" class="result-big">R$ 0,00</div>
    </div>
  </div>

  <script>
    const brl = v => v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    const val = id => parseFloat(String(document.getElementById(id).value).replace(',', '.')) || 0;
    const pct = id => { const raw = val(id); return (!isFinite(raw) ? 0 : (raw >= 1 ? raw/100 : raw)); };

    const itemsDiv = document.getElementById('items');
    // Armazena todos os IDs de custo ('bX') e quantidade ('cX')
    let PRODUCTS = [];
    // Contador para o próximo produto a ser criado
    let productCounter = 0; // Começamos em 0 para o primeiro produto ser o '1'
    // IDs fixos (porcentagens e checkbox)
    const FIXED_IDS = ['b8','b9','b10','b11','b12','divide2'];
    const PERSIST_KEY = 'precificador';

    // Função para criar a linha de um novo produto
    function createProductRow(index, costValue = '', qtyValue = 1, isVisible = false) {
      productCounter = index; // Atualiza o contador para o índice atual
      const bId = 'b' + index;
      const cId = 'c' + index;

      const wrap = document.createElement('div');
      wrap.className = 'row4 product-row';
      wrap.id = 'product-row-' + index;
      wrap.style.display = isVisible ? 'grid' : 'none';

      wrap.innerHTML = `
        <label>PRODUTO ${index}</label>
        <span></span>
        <input class="money" type="number" inputmode="decimal" step="0.01" id="${bId}" placeholder="0,00" value="${costValue}">
        <span></span>
        <span class="qtd-label">QTD</span>
        <span></span>
        <input class="qty" type="number" inputmode="numeric" pattern="[0-9]*" step="1" id="${cId}" value="${qtyValue}">
      `;
      itemsDiv.appendChild(wrap);
      
      PRODUCTS.push({ bId, cId });

      // Adicionar listeners
      const costInput = document.getElementById(bId);
      const qtyInput = document.getElementById(cId);

      costInput.addEventListener('input', handleProductInput, { passive:true });
      qtyInput.addEventListener('input', calc, { passive:true });

      return costInput.parentElement; // Retorna o elemento wrap para controle de visibilidade
    }

    // Função que gerencia a criação do próximo produto e a visibilidade
    function handleProductInput(e) {
      calc(); // Recalcula sempre que um campo muda

      const currentInput = e.target;
      const currentIndex = parseInt(currentInput.id.replace('b', ''));
      const currentValue = parseFloat(currentInput.value);

      // 1. Lógica para CRIAR e MOSTRAR o próximo produto
      if (currentValue > 0 && currentIndex === PRODUCTS.length) {
          const nextIndex = productCounter + 1;
          const newRow = createProductRow(nextIndex, '', 1, true); // Cria e já define como visível
      }
      
      // 2. Lógica para LIMPAR e ESCONDER linhas subsequentes (se o campo atual for esvaziado)
      if (currentValue === 0) {
          // Percorre de trás para frente
          for (let i = PRODUCTS.length; i > currentIndex; i--) {
              const product = PRODUCTS[i - 1];
              const costInput = document.getElementById(product.bId);
              const row = document.getElementById('product-row-' + i);
              
              // Se o produto atual na iteração estiver vazio, ele é removido
              if (parseFloat(costInput.value) === 0) {
                  itemsDiv.removeChild(row);
                  PRODUCTS.pop(); 
                  productCounter--;
              } else {
                  // Se encontrar um valor preenchido, para a remoção
                  break;
              }
          }
      }
      
      saveData();
    }
    
    // Adiciona listeners para os campos fixos
    FIXED_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', calc, { passive:true });
    });
    document.getElementById('divide2').addEventListener('change', calc);

    // Lógica de cálculo
    function calc(){
      let soma = 0;
      // Itera sobre o array PRODUCTS para somar todos os custos
      PRODUCTS.forEach(product => {
        const bi = val(product.bId);
        const ci = parseFloat(document.getElementById(product.cId).value) || 0;
        soma += bi * ci;
      });
      
      const dividir2 = document.getElementById('divide2').checked;
      const b7 = dividir2 ? soma / 2 : soma;

      const b8 = pct('b8'), b10 = pct('b10'), b11 = pct('b11'), b12 = pct('b12');
      const b9 = val('b9');

      const somaPct = b8 + b10 + b11 + b12;
      const denom = 1 - somaPct;
      document.getElementById('warn').style.display = (denom <= 0) ? 'block' : 'none';

      const b13 = denom <= 0 ? 0 : (b7 + b9) / denom;

      // valores em R$ derivados das porcentagens
      const margemR   = b13 * b8;
      const impostoR  = b13 * b10;
      const fixoR     = b13 * b11;
      const comissaoR = b13 * b12;

      document.getElementById('b7').textContent  = brl(b7);
      document.getElementById('b13').textContent = brl(b13);

      document.getElementById('r_b8').textContent  = brl(margemR);
      document.getElementById('r_b10').textContent = brl(impostoR);
      document.getElementById('r_b11').textContent = brl(fixoR);
      document.getElementById('r_b12').textContent = brl(comissaoR);

      saveData();
    }
    
    // Função para persistir dados no localStorage
    function saveData() {
        const data = {
            products: PRODUCTS.map(p => ({
                bId: p.bId,
                cId: p.cId,
                cost: document.getElementById(p.bId).value,
                qty: document.getElementById(p.cId).value
            })),
            fixed: {}
        };
        FIXED_IDS.forEach(id => {
            const el = document.getElementById(id);
            data.fixed[id] = (el?.type === 'checkbox') ? el.checked : el.value;
        });
        localStorage.setItem(PERSIST_KEY, JSON.stringify(data));
    }

    // Função para restaurar dados salvos
    function restoreData() {
        const saved = localStorage.getItem(PERSIST_KEY);
        if (!saved) {
            // Se não houver nada salvo, cria apenas o primeiro produto
            createProductRow(1, '', 1, true);
            return;
        }
        
        const data = JSON.parse(saved);
        
        // 1. Restaura produtos
        if (data.products && data.products.length > 0) {
            itemsDiv.innerHTML = '';
            PRODUCTS = [];
            
            data.products.forEach((p, index) => {
                const productIndex = index + 1;
                // Cria todos os produtos salvos
                createProductRow(productIndex, p.cost, p.qty, true);
                
                // Se for o último produto salvo e ele tiver valor, cria o próximo produto vazio
                if (index === data.products.length - 1 && parseFloat(p.cost) > 0) {
                    createProductRow(productIndex + 1, '', 1, true);
                }
            });
            // Garante que haja pelo menos um campo vazio visível para entrada
            if (PRODUCTS.length === 0 || parseFloat(data.products[data.products.length-1].cost) === 0) {
                 createProductRow(Math.max(1, productCounter + 1), '', 1, true);
            }
        } else {
            // Se o array de produtos estiver vazio, cria o primeiro
            createProductRow(1, '', 1, true);
        }
        
        // 2. Restaura campos fixos (porcentagens e checkbox)
        if (data.fixed) {
            Object.entries(data.fixed).forEach(([k, v]) => {
                const el = document.getElementById(k);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = !!v;
                else el.value = v;
            });
        }
    }

    // Processo de inicialização
    restoreData();
    // Garante que o cálculo seja executado na primeira carga, após restauração
    calc();

    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>
